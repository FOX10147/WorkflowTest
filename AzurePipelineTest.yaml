trigger:
- master

variables:
  azureSubscriptionEndpoint: Training
  azureContainerRegistry: revprojectfactory.azurecr.io
  azureResourceGroup: Project3
  kubernetesCluster: Project3Cluster

stages:
- stage: Build
  jobs: 
  - job: BuildJob
    displayName: Job Building
    workspace:
      clean: outputs
    steps: 
    - script: |
        echo "Building Project..."
        sh 'mvn package -DskipTests=true -Dcheckstyle.skip=true'
        echo "Finished Building Project"
- stage: Test
  jobs:
  - job: TestProject
    displayName: Project Testing
    dependsOn: Job Building
    steps:
    - script: |
        echo "Testing Project..."
        sh 'mvn test -Dcheckstyle.skip=true'
        echo "Finished Testing Project"
# - stage: Install Helm
#   jobs:
#   - job: InstallHelm
#     displayName: Install Helm Chart
#     dependsOn: Project Testing
#     steps:
#     - script: echo "Installing Helm Chart..."
#     - task: HelmInstaller@1
#       displayName: Helm Installer
#       inputs:
#         HelmVersionToInstall: latest
- stage: Deploy  
- job:
    displayName: Project Deployment
    dependsOn: Project Testing
    environment: 
      strategy:
        runOnce:
          deploy:
          steps: 
          - script: echo "Deploying Project..."
          - task: HelmDeploy@0
            displayName: Helm Deployment
            inputs:
              connectionType: Azure Resources Manager
              azureSubscriptionEndpoint: ${azureSubscriptionEndpoint}
              azureResourceGroup: ${azureResourceGroup}
              kubernetesCluster: ${kubernetesCluster}
#               command: install
#               chartType: FilePath
#               chartPath: Application/charts/sampleapp
          - script: echo "Finished Deploying Project"